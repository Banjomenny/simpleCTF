{% extends "base.html" %}

{% block title %}Scoreboard — BankingAI CTF{% endblock %}
{% block max_width %}1050px{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block nav %}
  <a href="/">Register / Login</a>
{% endblock %}

{% block content %}

{% if graph_data %}
<div class="card" style="margin-bottom:1.25rem;">
  <h2 style="margin-bottom:1rem;">
    Score Over Time
    <span class="muted" style="font-size:.72rem; font-weight:normal; font-family:var(--mono);"> — ET</span>
  </h2>
  <div style="position:relative; height:260px;">
    <canvas id="scoreChart"></canvas>
  </div>
</div>
{% endif %}

<div class="card" style="overflow-x:auto;">

  <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem;">
    <div>
      <h1 style="margin-bottom:.15rem;">Scoreboard</h1>
      <p class="muted" style="font-size:.8rem;">{{ board|length }} team(s) &nbsp;&middot;&nbsp; {{ max_score }} pts available</p>
    </div>
    <a href="/scoreboard" class="btn" style="width:auto; margin:0; padding:.4rem 1rem; font-size:.72rem;">&#8635; Refresh</a>
  </div>

  {% if board %}
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Team</th>
        {% for f in flags %}
          <th style="font-size:.6rem; max-width:80px; line-height:1.4;">
            {{ f.name }}<br>
            <span class="muted" style="font-weight:normal; font-size:.6rem;">{{ f.points }}pts</span>
          </th>
        {% endfor %}
        <th>Score</th>
        <th>Last Capture</th>
      </tr>
    </thead>
    <tbody>
      {% for entry in board %}
      <tr>
        <td class="mono muted">
          {% if loop.index == 1 and entry.score > 0 %}&#127881;
          {% elif loop.index == 2 and entry.score > 0 %}&#129352;
          {% elif loop.index == 3 and entry.score > 0 %}&#129353;
          {% else %}{{ loop.index }}{% endif %}
        </td>
        <td class="mono" style="color:var(--head);">{{ entry.name }}</td>
        {% for f in flags %}
          <td style="text-align:center;">
            {% if f.id in entry.flag_ids %}
              {% if f.id in entry.fb_flags %}
                <span style="color:var(--red);" title="First Blood!">&#9632;</span>
              {% else %}
                <span style="color:var(--green);">&#10003;</span>
              {% endif %}
            {% else %}
              <span class="muted">&mdash;</span>
            {% endif %}
          </td>
        {% endfor %}
        <td>
          <span class="mono" style="color:var(--green); font-weight:700;">{{ entry.score }}</span>
          <span class="muted" style="font-size:.78rem;"> / {{ max_score }}</span>
        </td>
        <td class="mono muted" style="font-size:.78rem;">{{ entry.last_capture or '&mdash;' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="muted" style="text-align:center; padding:3rem 0;">No teams registered yet.</p>
  {% endif %}

</div>

{% if graph_data %}
<script>
(function () {
  var raw   = {{ graph_data | tojson }};
  var teams = Object.keys(raw);
  if (!teams.length) return;

  var COLORS = ['#00c8ff','#00e587','#ff3d52','#ffaa00','#bc8cff','#79c0ff','#ffa657','#ff7b72'];

  var datasets = teams.map(function(team, i) {
    return {
      label:           team,
      data:            raw[team],
      borderColor:     COLORS[i % COLORS.length],
      backgroundColor: COLORS[i % COLORS.length] + '18',
      fill:            false,
      stepped:         'before',
      tension:         0,
      pointRadius:     3,
      pointHoverRadius: 6,
      borderWidth:     2,
    };
  });

  new Chart(document.getElementById('scoreChart'), {
    type: 'line',
    data: { datasets: datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      parsing: false, animation: false,
      scales: {
        x: {
          type: 'linear',
          grid:   { color: '#142030' },
          border: { color: '#1c3048' },
          ticks: {
            color: '#375570',
            font: { family: "'JetBrains Mono', 'Courier New'", size: 11 },
            maxTicksLimit: 8,
            callback: function(val) {
              return new Date(val).toLocaleTimeString('en-US', {
                timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', hour12: false
              });
            }
          }
        },
        y: {
          min: 0, max: {{ max_possible }},
          grid:   { color: '#142030' },
          border: { color: '#1c3048' },
          ticks: {
            color: '#375570',
            font: { family: "'JetBrains Mono', 'Courier New'", size: 11 },
            stepSize: 100,
          }
        }
      },
      plugins: {
        legend: {
          labels: {
            color: '#6aa0c0',
            font: { family: "'JetBrains Mono', 'Courier New'", size: 12 },
            boxWidth: 12, padding: 16,
          }
        },
        tooltip: {
          backgroundColor: '#0a1520', borderColor: '#142030', borderWidth: 1,
          titleColor: '#375570', bodyColor: '#6aa0c0',
          callbacks: {
            title: function(items) {
              return new Date(items[0].parsed.x).toLocaleString('en-US', {
                timeZone: 'America/New_York', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
              }) + ' ET';
            },
            label: function(item) {
              return '  ' + item.dataset.label + ': ' + item.parsed.y + ' pts';
            }
          }
        }
      }
    }
  });
})();
</script>
{% endif %}

{% endblock %}
