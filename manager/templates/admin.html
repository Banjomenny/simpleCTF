{% extends "base.html" %}

{% block title %}Admin Panel{% endblock %}
{% block max_width %}1100px{% endblock %}

{% block nav %}
  <span class="nav-chip">admin</span>
  <form method="POST" action="/admin/logout">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit">Log out</button>
  </form>
{% endblock %}

{% block content %}
<div class="card" style="overflow-x:auto;">

  <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem;">
    <div>
      <h1 style="margin-bottom:.15rem;">Admin Panel</h1>
      <p class="muted" style="font-size:.8rem;">{{ teams|length }} team(s) registered</p>
    </div>
    <a href="/admin" class="btn" style="width:auto; margin:0; padding:.4rem 1rem; font-size:.72rem;">&#8635; Refresh</a>
  </div>

  {% if teams %}
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Team</th>
        <th>Port</th>
        <th>Status</th>
        <th>Score</th>
        <th>Flags</th>
        <th>Registered</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
    {% for team in teams %}
      <tr>
        <td class="mono muted">{{ team.id }}</td>
        <td class="mono" style="color:var(--head);">{{ team.name }}</td>
        <td class="mono">{{ team.port }}</td>
        <td><span class="badge {{ team.status }}">{{ team.status }}</span></td>
        <td class="mono" style="color:var(--green); font-weight:700;">{{ team.score }}</td>
        <td class="muted">{{ team.captures }}/5</td>
        <td class="muted mono" style="font-size:.78rem;">{{ team.created_at }}</td>
        <td>
          <div style="display:flex;flex-wrap:wrap;gap:.3rem;align-items:center;">
            {% if team.status != 'stopped' %}
            <form class="action-form" method="POST" action="/admin/stop/{{ team.name }}"
                  onsubmit="return confirm('Stop + wipe {{ team.name }}?')">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="danger">Stop</button>
            </form>
            {% endif %}
            <form class="action-form" method="POST" action="/admin/restart/{{ team.name }}"
                  onsubmit="return confirm('Restart {{ team.name }}?')">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="secondary">Restart</button>
            </form>
            <form class="action-form" method="POST" action="/admin/delete/{{ team.name }}"
                  onsubmit="return confirm('Permanently delete {{ team.name }}? This cannot be undone.')">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="danger">Delete</button>
            </form>
            <span class="action-form">
              <button type="button" class="secondary"
                      onclick="toggleReset('{{ team.name }}')">Reset PW</button>
            </span>
          </div>
          <form id="pwr-{{ team.name }}" method="POST"
                action="/admin/reset-password/{{ team.name }}"
                style="display:none;align-items:center;gap:.3rem;margin-top:.4rem;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="password" name="new_password" placeholder="new password"
                   minlength="8" required
                   style="background:var(--bg);border:1px solid var(--bdr2);color:var(--head);
                          font-family:var(--mono);font-size:.78rem;padding:.28rem .5rem;
                          outline:none;width:140px;">
            <button type="submit"
                    style="margin:0;width:auto;padding:.28rem .65rem;font-size:.7rem;">Set</button>
          </form>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="muted" style="text-align:center; padding:3rem 0; font-size:.9rem;">No teams registered yet.</p>
  {% endif %}

</div>
{% endblock %}

{% block head_extra %}
<script>
  function toggleReset(name) {
    var f = document.getElementById('pwr-' + name);
    var showing = f.style.display === 'flex';
    f.style.display = showing ? 'none' : 'flex';
    if (!showing) f.querySelector('input').focus();
  }
</script>
{% endblock %}
